#!/bin/bash
set -e
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
WORKSPACE=$(realpath "${SCRIPT_DIR}/..")

echo "Post-create setup starting..."

# Basic git setup
git config --global --add safe.directory ${WORKSPACE} 2>/dev/null || true

cd ${WORKSPACE} && ./setup-nvm.sh
cd ${WORKSPACE} && ./ensure-git-globals.sh
cd ${WORKSPACE} && ./recover-yarn.sh

cd ${WORKSPACE} && export COREPACK_ENABLE_DOWNLOAD_PROMPT=0 && yes | corepack enable

# Setup Yarn Berry
echo "Setting up Yarn Berry..."
cd ${WORKSPACE} && corepack prepare yarn@${DEFAULT_YARN_VERSION} --activate && corepack yarn set version ${DEFAULT_YARN_VERSION} || echo "Yarn Berry setup failed"

# Install dependencies
echo "Installing dependencies..."
cd ${WORKSPACE} && corepack yarn config set nodeLinker node-modules
cd ${WORKSPACE} && ./npm-install-globals.sh
cd ${WORKSPACE} && ./do-yarn.sh || echo "Dependency installation failed"


cd ${WORKSPACE} && /usr/local/bin/mkcert -install
cd ${WORKSPACE} && /usr/local/bin/mkcert localhost 127.0.0.1 ::1 {{hostname}}

echo ""
cd ${WORKSPACE} && yarn playwright install --with-deps || echo "Playwright installation failed"

echo "Checking for Verdaccio on host machine..."
if curl -sS -o /dev/null --fail http://localhost:4873/; then
  echo 'Verdaccio is running. Setting NPM registry to http://localhost:4873/'; 
  npm config set registry http://localhost:4873/;
else
  echo 'Verdaccio not detected on host:4873. Using default NPM registry (https://registry.npmjs.org/).';
fi


echo "Post-create setup complete"
