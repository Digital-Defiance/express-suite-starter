import {
  I18nEngine,
  LanguageCodes,
  createDefaultLanguages,
  createCoreComponentRegistration,
} from '@digitaldefiance/i18n-lib';
import type { ComponentConfig, EngineConfig } from '@digitaldefiance/i18n-lib';
import { StarterStringKey } from './starter-string-key';

export const StarterI18nEngineKey = 'DigitalDefiance.Starter.I18nEngine' as const;
export const StarterComponentId = 'express-suite-starter' as const;

export function createStarterComponentConfig(): ComponentConfig {
  const translations: Record<string, Record<StarterStringKey, string>> = {
    [LanguageCodes.EN_US]: {
      [StarterStringKey.CLI_GeneratingProject]: 'Generating project...',
      [StarterStringKey.CLI_ProjectGenerated]: 'Project generated successfully',
      [StarterStringKey.CLI_ValidationFailed]: 'Validation failed',
      [StarterStringKey.CLI_ExecutingStep]: 'Executing step: {step}',
      [StarterStringKey.CLI_StepComplete]: 'Step complete',
      [StarterStringKey.CLI_Error]: 'Error: {message}',
      [StarterStringKey.Validation_InvalidProjectName]: 'Invalid project name',
      [StarterStringKey.Validation_InvalidPackageName]: 'Invalid package name',
      [StarterStringKey.Validation_DirectoryExists]: 'Directory already exists',
      [StarterStringKey.Validation_InvalidNodeVersion]: 'Invalid Node.js version',
      [StarterStringKey.Success_ProjectCreated]: 'Project created successfully',
      [StarterStringKey.Success_DependenciesInstalled]: 'Dependencies installed',
      [StarterStringKey.Success_ConfigurationComplete]: 'Configuration complete',
    },
    [LanguageCodes.EN_GB]: {
      [StarterStringKey.CLI_GeneratingProject]: 'Generating project...',
      [StarterStringKey.CLI_ProjectGenerated]: 'Project generated successfully',
      [StarterStringKey.CLI_ValidationFailed]: 'Validation failed',
      [StarterStringKey.CLI_ExecutingStep]: 'Executing step: {step}',
      [StarterStringKey.CLI_StepComplete]: 'Step complete',
      [StarterStringKey.CLI_Error]: 'Error: {message}',
      [StarterStringKey.Validation_InvalidProjectName]: 'Invalid project name',
      [StarterStringKey.Validation_InvalidPackageName]: 'Invalid package name',
      [StarterStringKey.Validation_DirectoryExists]: 'Directory already exists',
      [StarterStringKey.Validation_InvalidNodeVersion]: 'Invalid Node.js version',
      [StarterStringKey.Success_ProjectCreated]: 'Project created successfully',
      [StarterStringKey.Success_DependenciesInstalled]: 'Dependencies installed',
      [StarterStringKey.Success_ConfigurationComplete]: 'Configuration complete',
    },
    [LanguageCodes.ES]: {
      [StarterStringKey.CLI_GeneratingProject]: 'Generando proyecto...',
      [StarterStringKey.CLI_ProjectGenerated]: 'Proyecto generado exitosamente',
      [StarterStringKey.CLI_ValidationFailed]: 'Validación fallida',
      [StarterStringKey.CLI_ExecutingStep]: 'Ejecutando paso: {step}',
      [StarterStringKey.CLI_StepComplete]: 'Paso completado',
      [StarterStringKey.CLI_Error]: 'Error: {message}',
      [StarterStringKey.Validation_InvalidProjectName]: 'Nombre de proyecto inválido',
      [StarterStringKey.Validation_InvalidPackageName]: 'Nombre de paquete inválido',
      [StarterStringKey.Validation_DirectoryExists]: 'El directorio ya existe',
      [StarterStringKey.Validation_InvalidNodeVersion]: 'Versión de Node.js inválida',
      [StarterStringKey.Success_ProjectCreated]: 'Proyecto creado exitosamente',
      [StarterStringKey.Success_DependenciesInstalled]: 'Dependencias instaladas',
      [StarterStringKey.Success_ConfigurationComplete]: 'Configuración completa',
    },
    [LanguageCodes.FR]: {
      [StarterStringKey.CLI_GeneratingProject]: 'Génération du projet...',
      [StarterStringKey.CLI_ProjectGenerated]: 'Projet généré avec succès',
      [StarterStringKey.CLI_ValidationFailed]: 'Échec de la validation',
      [StarterStringKey.CLI_ExecutingStep]: 'Exécution de l\'étape : {step}',
      [StarterStringKey.CLI_StepComplete]: 'Étape terminée',
      [StarterStringKey.CLI_Error]: 'Erreur : {message}',
      [StarterStringKey.Validation_InvalidProjectName]: 'Nom de projet invalide',
      [StarterStringKey.Validation_InvalidPackageName]: 'Nom de paquet invalide',
      [StarterStringKey.Validation_DirectoryExists]: 'Le répertoire existe déjà',
      [StarterStringKey.Validation_InvalidNodeVersion]: 'Version de Node.js invalide',
      [StarterStringKey.Success_ProjectCreated]: 'Projet créé avec succès',
      [StarterStringKey.Success_DependenciesInstalled]: 'Dépendances installées',
      [StarterStringKey.Success_ConfigurationComplete]: 'Configuration terminée',
    },
    [LanguageCodes.DE]: {
      [StarterStringKey.CLI_GeneratingProject]: 'Projekt wird generiert...',
      [StarterStringKey.CLI_ProjectGenerated]: 'Projekt erfolgreich generiert',
      [StarterStringKey.CLI_ValidationFailed]: 'Validierung fehlgeschlagen',
      [StarterStringKey.CLI_ExecutingStep]: 'Schritt wird ausgeführt: {step}',
      [StarterStringKey.CLI_StepComplete]: 'Schritt abgeschlossen',
      [StarterStringKey.CLI_Error]: 'Fehler: {message}',
      [StarterStringKey.Validation_InvalidProjectName]: 'Ungültiger Projektname',
      [StarterStringKey.Validation_InvalidPackageName]: 'Ungültiger Paketname',
      [StarterStringKey.Validation_DirectoryExists]: 'Verzeichnis existiert bereits',
      [StarterStringKey.Validation_InvalidNodeVersion]: 'Ungültige Node.js-Version',
      [StarterStringKey.Success_ProjectCreated]: 'Projekt erfolgreich erstellt',
      [StarterStringKey.Success_DependenciesInstalled]: 'Abhängigkeiten installiert',
      [StarterStringKey.Success_ConfigurationComplete]: 'Konfiguration abgeschlossen',
    },
    [LanguageCodes.ZH_CN]: {
      [StarterStringKey.CLI_GeneratingProject]: '正在生成项目...',
      [StarterStringKey.CLI_ProjectGenerated]: '项目生成成功',
      [StarterStringKey.CLI_ValidationFailed]: '验证失败',
      [StarterStringKey.CLI_ExecutingStep]: '正在执行步骤：{step}',
      [StarterStringKey.CLI_StepComplete]: '步骤完成',
      [StarterStringKey.CLI_Error]: '错误：{message}',
      [StarterStringKey.Validation_InvalidProjectName]: '无效的项目名称',
      [StarterStringKey.Validation_InvalidPackageName]: '无效的包名称',
      [StarterStringKey.Validation_DirectoryExists]: '目录已存在',
      [StarterStringKey.Validation_InvalidNodeVersion]: '无效的 Node.js 版本',
      [StarterStringKey.Success_ProjectCreated]: '项目创建成功',
      [StarterStringKey.Success_DependenciesInstalled]: '依赖项已安装',
      [StarterStringKey.Success_ConfigurationComplete]: '配置完成',
    },
    [LanguageCodes.JA]: {
      [StarterStringKey.CLI_GeneratingProject]: 'プロジェクトを生成中...',
      [StarterStringKey.CLI_ProjectGenerated]: 'プロジェクトが正常に生成されました',
      [StarterStringKey.CLI_ValidationFailed]: '検証に失敗しました',
      [StarterStringKey.CLI_ExecutingStep]: 'ステップを実行中：{step}',
      [StarterStringKey.CLI_StepComplete]: 'ステップ完了',
      [StarterStringKey.CLI_Error]: 'エラー：{message}',
      [StarterStringKey.Validation_InvalidProjectName]: '無効なプロジェクト名',
      [StarterStringKey.Validation_InvalidPackageName]: '無効なパッケージ名',
      [StarterStringKey.Validation_DirectoryExists]: 'ディレクトリは既に存在します',
      [StarterStringKey.Validation_InvalidNodeVersion]: '無効な Node.js バージョン',
      [StarterStringKey.Success_ProjectCreated]: 'プロジェクトが正常に作成されました',
      [StarterStringKey.Success_DependenciesInstalled]: '依存関係がインストールされました',
      [StarterStringKey.Success_ConfigurationComplete]: '設定完了',
    },
    [LanguageCodes.UK]: {
      [StarterStringKey.CLI_GeneratingProject]: 'Генерація проекту...',
      [StarterStringKey.CLI_ProjectGenerated]: 'Проект успішно згенеровано',
      [StarterStringKey.CLI_ValidationFailed]: 'Помилка валідації',
      [StarterStringKey.CLI_ExecutingStep]: 'Виконання кроку: {step}',
      [StarterStringKey.CLI_StepComplete]: 'Крок завершено',
      [StarterStringKey.CLI_Error]: 'Помилка: {message}',
      [StarterStringKey.Validation_InvalidProjectName]: 'Недійсна назва проекту',
      [StarterStringKey.Validation_InvalidPackageName]: 'Недійсна назва пакету',
      [StarterStringKey.Validation_DirectoryExists]: 'Директорія вже існує',
      [StarterStringKey.Validation_InvalidNodeVersion]: 'Недійсна версія Node.js',
      [StarterStringKey.Success_ProjectCreated]: 'Проект успішно створено',
      [StarterStringKey.Success_DependenciesInstalled]: 'Залежності встановлено',
      [StarterStringKey.Success_ConfigurationComplete]: 'Конфігурацію завершено',
    },
  };

  return {
    id: StarterComponentId,
    strings: translations,
  };
}

let _starterEngine: I18nEngine | undefined;

export function getStarterI18nEngine(config?: EngineConfig): I18nEngine {
  if (!_starterEngine || !I18nEngine.hasInstance('default')) {
    const engine = I18nEngine.registerIfNotExists('default', createDefaultLanguages(), config);
    
    const coreReg = createCoreComponentRegistration();
    engine.registerIfNotExists({
      id: coreReg.component.id,
      strings: coreReg.strings as Record<string, Record<string, string>>,
    });
    
    const starterConfig = createStarterComponentConfig();
    const result = engine.registerIfNotExists({
      ...starterConfig,
      aliases: ['StarterStringKey'],
    });
    
    if (!result.isValid && result.errors.length > 0) {
      console.warn(`Starter component has ${result.errors.length} errors`, result.errors.slice(0, 5));
    }
    
    _starterEngine = engine;
  }
  return _starterEngine;
}

export const starterI18nEngine = new Proxy({} as I18nEngine, {
  get(target, prop) {
    return getStarterI18nEngine()[prop as keyof I18nEngine];
  },
});

export function resetStarterI18nEngine(): void {
  _starterEngine = undefined;
}

export function getStarterTranslation(
  stringKey: StarterStringKey,
  variables?: Record<string, string | number>,
  language?: string,
): string {
  return getStarterI18nEngine().translate(StarterComponentId, stringKey, variables, language);
}

export function safeStarterTranslation(
  stringKey: StarterStringKey,
  variables?: Record<string, string | number>,
  language?: string,
): string {
  try {
    return getStarterTranslation(stringKey, variables, language);
  } catch {
    return `[${stringKey}]`;
  }
}
